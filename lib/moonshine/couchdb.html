<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>couchdb.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>couchdb.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><strong>Moonshine::Couchdb</strong> is a Moonshine plugin for installing and configuring <a href="couchbase">Couchbase Single Server Community Edition</a></p>

<p>This documentation is generated by rocco, and is more developery in nature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Moonshine</span>
  <span class="k">module</span> <span class="nn">Couchdb</span></pre></div>
      </td>
    </tr>
    <tr id='section-Prerequisites'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Prerequisites">&#182;</a>
        </div>
        <h1>Prerequisites</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>We start off configuring some sane default options,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
      <span class="n">manifest</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>but really there&rsquo;s only <code>:version</code> for now.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">configure</span> <span class="ss">:couchdb</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">1</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Recipe'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Recipe">&#182;</a>
        </div>
        <h1>Recipe</h1>

<p>We define the <code>:couchdb</code> recipe which can take inline options.</p>

<p>Currently, this respects the following options:</p>

<ul>
<li><code>:version</code>: version to download, see the <a href="http://info.couchbase.com/couchbaseCEdownload.html">download page</a> for what&rsquo;s available</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">couchdb</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>couchbase is available online to download, but not from a debian repository.
we&rsquo;ll need us some wget and a place to download it to (/usr/local/src)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">package</span> <span class="s1">&#39;wget&#39;</span><span class="p">,</span> <span class="ss">:ensure</span> <span class="o">=&gt;</span> <span class="ss">:installed</span>
      <span class="n">file</span> <span class="s1">&#39;/usr/local/src&#39;</span><span class="p">,</span>
        <span class="ss">:ensure</span> <span class="o">=&gt;</span> <span class="ss">:directory</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>The couchbase downloads have an architecture in them, but we can rely on Facter for this.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">arch</span> <span class="o">=</span> <span class="no">Facter</span><span class="o">.</span><span class="n">architecture</span>
      <span class="n">deb_filename</span> <span class="o">=</span> <span class="s2">&quot;couchbase-server-community_</span><span class="si">#{</span><span class="n">arch</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:version</span><span class="o">]</span><span class="si">}</span><span class="s2">.deb&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Download couchbase, like a bau5.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">exec</span> <span class="s1">&#39;download couchbase&#39;</span><span class="p">,</span>
        <span class="ss">:alias</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/local/src/</span><span class="si">#{</span><span class="n">deb_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:creates</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/local/src/</span><span class="si">#{</span><span class="n">deb_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="s1">&#39;/usr/local/src&#39;</span><span class="p">,</span>
        <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="n">package</span><span class="p">(</span><span class="s1">&#39;wget&#39;</span><span class="p">),</span> <span class="n">file</span><span class="p">(</span><span class="s1">&#39;/usr/local/src&#39;</span><span class="p">)</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:command</span> <span class="o">=&gt;</span> <span class="s2">&quot;wget --quiet http://c3145442.r42.cf0.rackcdn.com/</span><span class="si">#{</span><span class="n">deb_filename</span><span class="si">}</span><span class="s2"> --output-document=</span><span class="si">#{</span><span class="n">deb_filename</span><span class="si">}</span><span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>With couchbase downloaded, we can use the dpkg provider to ensure the couchbase-server is installed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">package</span> <span class="s1">&#39;couchbase-server&#39;</span><span class="p">,</span>
        <span class="ss">:ensure</span> <span class="o">=&gt;</span> <span class="ss">:installed</span><span class="p">,</span>
        <span class="ss">:provider</span> <span class="o">=&gt;</span> <span class="ss">:dpkg</span><span class="p">,</span>
        <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/local/src/</span><span class="si">#{</span><span class="n">deb_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="nb">exec</span><span class="p">(</span><span class="s1">&#39;download couchbase&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>With it installed, make sure it&rsquo;s running.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">service</span> <span class="s1">&#39;couchbase-server&#39;</span><span class="p">,</span>
        <span class="ss">:ensure</span> <span class="o">=&gt;</span> <span class="ss">:running</span><span class="p">,</span>
        <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="n">package</span><span class="p">(</span><span class="s1">&#39;couchbase-server&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>couchbase-server works out of the box, but if any other configuration was needed, this would be a good place for it.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">end</span>
    
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
